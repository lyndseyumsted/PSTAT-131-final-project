---
title: "XGBoost Classification"
author: "Lyndsey Umsted"
date: "2022-11-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading neccessary libraries:
```{r}
library(tidyverse)
library(dplyr)
library(glmnet)
library(xgboost)
library(ranger)
library(lsr)
library(corrr)
library(tidyr)
library(car)
library(moments)
library(ggpubr)
library(BBmisc)
library(rsample)
library(recipes)
library(randomForest)
library(parsnip)
library(workflows)
library(tune)
library(dials)
library(yardstick)
require(xgboost)
require(data.table)
require(Matrix)
library(caret)
library(data.table)
library(mlr3)
library(class)
library(ParamHelpers)
```

Splitting into training and testing
```{r}
setwd("C:/Users/18586/Desktop/PSTAT 131/PSTAT-131-final-project/models")
load("pandemic_cum.rda")

set.seed(2002)

pandemic_cum <- pandemic_cum %>%
  select(-c("prop", "confirmed_cases", "population", "ID_co"))

pandemic_cum_split <- initial_split(pandemic_cum, prop = 0.80, strata = risk)

pandemic_cum_train <- training(pandemic_cum_split)
pandemic_cum_test <- testing(pandemic_cum_split)

pandemic_folds <- vfold_cv(pandemic_cum_train, v = 10, strata = risk)  # 10-fold CV

```

```{r}
set.seed(123)
xgb_spec <-
  boost_tree(
    mtry = tune(),
    trees = tune(),
    min_n = tune()
  ) %>%
  set_engine('xgboost') %>%
  set_mode('classification')

# add it to a workflow
xgb_wflow <-
  workflow() %>%
  add_formula(risk ~ Mean_Tmax + Urban + PovertyRate + MedianFamilyIncome + Traffic + Solid.Waste + Asthma + Low.Birth.Weight + Cardiovascular.Disease + Education + Linguistic.Isolation + Unemployment + under_10_. + Age11_to_64_. + over_65_. + Hispanic_. + White_. + African_Am_. + Asian_Am_. + Native_Am_. + Other_ethnicity_.) %>%
  add_model(xgb_spec)

xgb_grid <- grid_regular(mtry(range = c(2, 20)), trees(range = c(6, 10)), min_n(range = c(3, 5)),levels = 8)

# tune mtry, trees, min_n, tree_depth, etc.
xgb_res <-
  tune_grid(
    xgb_wflow,
    resamples = pandemic_folds,
    grid = xgb_grid,
    metrics = metric_set(roc_auc)
  )
```

```{r}
autoplot(xgb_res)
```

```{r}
best <- select_best(xgb_res)

xgb_final <- finalize_workflow(xgb_wflow, best)

xgb_final_fit <- fit(xgb_final, data = pandemic_cum_train)

xgb_final_fit %>%
  extract_fit_parsnip() %>%
  vip()
```

accuracy on training:
```{r}
augment(xgb_final_fit, new_data = pandemic_cum_train) %>%
  accuracy(truth = risk, estimate = .pred_class)
```


accuracy on testing:
```{r}
augment(xgb_final_fit, new_data = pandemic_cum_test) %>%
  accuracy(truth = risk, estimate = .pred_class)
```



AUC:
```{r}
roc <- augment(xgb_final_fit, pandemic_cum_test)

xgb_roc <- roc %>%
  roc_auc(risk, c(.pred_low, .pred_moderate, .pred_high))

xgb_roc
```

ROC Curves:
```{r}
roc %>%
  roc_curve(risk, c(.pred_low, .pred_moderate, .pred_high)) %>%
  autoplot()
```


Confusion Matrix:
```{r}
augment(xgb_final_fit, new_data = pandemic_cum_test) %>%
  conf_mat(truth = risk, estimate = .pred_class) %>%
  autoplot(type = "heatmap")
```



